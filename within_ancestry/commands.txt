# looking at diversity within A, C, and M ancestry, pi within, and Fst between populations,
# as we move away from the origin of the Africanized honey bee invasion in Brazil

# steps
# (0) CALL HOMOZYGOUS ANCESTRY TRACTS for AA/CC/MM ancestry above 0.8 posterior probability of having homozygous ancestry across those tracts
output: (e.g.)
local_ancestry/results/tracts/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/AA/CA1207.bed'
# (1) Get bam reads that overlap tracts:
# small test -- works great!
bees/within_ancestry$ parallel './getBamsForTracts.sh {1} {2} {3} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot' ::: CA1207 ::: 3 :::+ CC
# all files:
within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/get_BAMS_AA_CC_MM_ancestry_tracts_0.8.log './getBamsForTracts.sh {1} {2} {3} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot' :::: ../bee_samples_listed/byPop/pops_included.IDs ::: 3 6 8 :::+ CC MM AA &> logs/get_BAMS_AA_CC_MM_ancestry_tracts_0.8.out &
[1] 2874

# (2) calculate pi for each population in ANGSD
# quick test file:
RUNNING (looks like it's working but may take up to a few hours per pop per ancestry)
./pi_within_ancestry.sh AR01 CC thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot ../bee_samples_listed/byPop/AR01.list

# run admixed populations - get pi within ancestry.
bees/within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/calc_pi_within_ancestry.log './pi_within_ancestry.sh {2} {1} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot ../bee_samples_listed/byPop/{2}.list' ::: AA CC MM :::: ../bee_samples_listed/byPop/pops_included.list &> logs/calc_pi_within_ancestry.out &
[1] 29414 - RUNNING 8.2.19

# run reference populations, using all reads
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_pi_all.log './pi.sh {1} ../bee_samples_listed/byPop/{1}.list' :::: ../bee_samples_listed/byPop/pops_included_plus_ACM.list &> logs/calc_pi_all.out &
[4] 13830 - RUNNING 8.2.19

# ALTERNATIVELY, I could use the called SNPs for Fst, and get allele freq's for each pop at each of those called SNPs, (filtering w/in ancestry), and quickly calculate Fst etc. from that. This would help me quickly scan for any 'smoking gun' functional differences too. BUT I would miss a new mutation not in this set of alleles, so IF any outliers look like they drop a lot of diversity within ancestry, like a hard sweep, it's also worth looking at those outlier regions using all SNPs from ANGSD and not just previously called SNPs.
# Get all SNPs in a useable 'sites' file for ANGSD:
# filters to only > .05 MAF at start and no non ACGT alleles
data/bees_new_positions$ awk '$3>=.05 && $5!='0' && $6!='0' {print $0}' ALL.bim | cut -f2,5,6 | tr "." "\t" | awk '{print $2"."$3"\t"$4"\t"$5"\t"$6}' > ALL.var.sites
# index this variant sites file for angsd:
data/bees_new_positions$ angsd sites index ALL.var.sites
# calculate allele frequencies at all those SNPs using simple counts:
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_allele_freq_within_ancestry.log './allele_freq_within_ancestry.sh {2} {1} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot ../bee_samples_listed/byPop/{2}.list ../data/bees_new_positions/ALL.var.sites' ::: AA CC MM :::: ../bee_samples_listed/byPop/pops_included.list &> logs/calc_allele_freq_within_ancestry.out &
[2] 1142 - RUNNING 8.2.19. COMPLETED.
# TO DO: get allele freq's for reference bees too, so I can calculate Fst and have a reference for expected diversity pi (e.g. shouldn't exceed or ancestry calls are off).
# really I want allele freq's for all populations at all the SNPs (across ancestries)
(!) NOTE - I may have swapped major/minor alleles when going from plink to sites file
# because the reference should match the major allele most of the time, not the minor
# get allele freqs at snps for all bees at all sites (ignoring ancestry)
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_allele_freq_all.log './allele_freq.sh {1} ../bee_samples_listed/byPop/{1}.list ../data/bees_new_positions/ALL.var.sites' :::: ../bee_samples_listed/byPop/pops_included_plus_ACM.list &> logs/calc_allele_freq_all.out &
[3] 9833 - RUNNING 8.2.19. COMPLETED.

# translate allele freqs over to all sites (including NA for no data):
# across all ancestries:
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/combine_allele_freq_all.log 'Rscript ./combine_pop_allele_freqs.R {1} results/allele_freq_all ../data/bees_new_positions/ALL.var.sites' :::: ../bee_samples_listed/byPop/pops_included_plus_ACM.list &> logs/combine_allele_freq_all.out &
[1] 3151 - RUNNING 8.5.19
# for each ancestry separately:
within_ancestry$ nohup parallel --noswap --jobs 3 --joblog logs/combine_allele_freq_within_ancestry.log 'Rscript ./combine_pop_allele_freqs.R {2} results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/{1}/allele_freq  ../data/bees_new_positions/ALL.var.sites' ::: AA CC MM :::: ../bee_samples_listed/byPop/pops_included.list &> logs/combine_allele_freq_within_ancestry.out &
[2] 3855 - RUNNING 8.5.19

# TO DO: paste results together across populations to get 1 file. possibly filter to 1/10 of data before loading into R for genome-wide estimate.
# Plot these first, but then use ANGSD to just get a random subset of the genome
# and pi/Fst across the top outliers for shared ancestry

# for some reason these summary files will not be created in parallel easily:
bees/within_ancestry$ for anc in AA CC MM; do paste $(for i in $(cat ../bee_samples_listed/byPop/pops_included.list); do echo results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/$anc/allele_freq/$i.freqs.txt; done ) | awk 'NR == 1 || NR % 100 == 0' > results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/$anc/allele_freq/pops_included_every100th_SNP.freqs.txt; done
bees/within_ancestry$ for anc in AA CC MM; do paste $(for i in $(cat ../bee_samples_listed/byPop/pops_included.list); do echo results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/$anc/allele_freq/$i.nInd; done ) | awk 'NR == 1 || NR % 10 == 0' > results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/$anc/allele_freq/pops_included_every10th_SNP.nInd; done

# for across all ancestry frequencies
/results/allele_freq_all$ paste $(for i in $(cat /media/erin/8TB/Documents/gitErin/bees/bee_samples_listed/byPop/pops_included_plus_ACM.list); do echo $i.freqs.txt; done ) | awk 'NR == 1 || NR % 100 == 0' > pops_included_plus_ACM_every100th_SNP.freqs.txt
/results/allele_freq_all$ paste $(for i in $(cat /media/erin/8TB/Documents/gitErin/bees/bee_samples_listed/byPop/pops_included_plus_ACM.list); do echo $i.freqs.txt; done ) | awk 'NR == 1 || NR % 10 == 0' > pops_included_plus_ACM_every10th_SNP.freqs.txt
/results/allele_freq_all$ paste $(for i in $(cat /media/erin/8TB/Documents/gitErin/bees/bee_samples_listed/byPop/pops_included_plus_ACM.list); do echo $i.nInd; done ) | awk 'NR == 1 || NR % 100 == 0' > pops_included_plus_ACM_every100th_SNP.nInd
/results/allele_freq_all$ paste $(for i in $(cat /media/erin/8TB/Documents/gitErin/bees/bee_samples_listed/byPop/pops_included_plus_ACM.list); do echo $i.nInd; done ) | awk 'NR == 1 || NR % 10 == 0' > pops_included_plus_ACM_every10th_SNP.nInd

# alternatively, I could take subsets of the SNPs, or filter by # in pop. with data
# TO DO: I could also do PCA instead of all pairwise Fst's, at least to start

# (3) calculate Fst between populations for all pairs in just a subset of 2 CA pops and 3 AR pops, and reference bees A/C/M, also in ANGSD

# (4) get allele frequencies for each population and each ancestry



# For outlier regions, I want to confirm ancestry by getting pi and Fst
# combined across all ancestries for my groups: NA_1, NA_2, SA_0, SA_1, SA_2,
# all NA (NA_3), all SA (SA_3), A, C, and M.
# first test parallel for pulling out column ID's by their name:
within_ancestry$ parallel --header : --colsep '\t' echo sample={pop} region={region_n} chr={chr} :::: groups_theta.list :::: ../functional_analysis/results/outlier_regions/all.plus20kb.bed
# works great!
# now run script:
# I add a 20kb buffer to either side of the putative selected region, looking for return to neutral background
within_ancestry$ nohup parallel --noswap --jobs 3 --joblog logs/calc_pi_outliers.log --header : --colsep '\t' 'echo group={pop} region={region}, n={region_n}; ./calc_theta_regions.sh {pop} ../bee_samples_listed/byPop/{pop}.list {region} {region_n}' :::: groups_theta.list :::: ../functional_analysis/results/outlier_regions/all.plus20kb.bed &> logs/calc_pi_outliers.out &
[1] 4083 - RUNNING 8.10.19 (will take a few hours). COMPLETED. check files because of 'failed' terms in log.

# now get Fst for these outlier regions:
within_ancestry$ nohup parallel --noswap --jobs 3 --joblog logs/calc_fst_outliers.log --header : --colsep '\t' 'echo pop1={pop1} pop2={pop2} region={region} region_n={region_n}; ./calc_pairwise_fst.sh {pop1} {pop2} results/outlier_regions/region_{region_n}/combined/' :::: pairs_fst.list :::: ../functional_analysis/results/outlier_regions/all.plus20kb.bed &> logs/calc_fst_outliers.out &
[2] 14414 - RUNNING 8.12.19. Accidentally rerunning:
[1] 27092 - 8.12.19


# now calculate pi and fst within ancestry for outliers:
# starting with pi for just combined NA and SA groups:


within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/calc_pi_outliers_NA_SA_3_within_ancestry.log --header : --colsep '\t' 'echo group={pop} region={region}, n={region_n}; ./calc_theta_regions_within_ancestry.sh {pop} ../bee_samples_listed/byPop/{pop}.list {region} {region_n} {ancestry} results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/{ancestry}/bams' :::: AA_MM_CC.list :::: NA_SA_3.list :::: ../functional_analysis/results/outlier_regions/all.plus20kb.bed &> logs/calc_pi_outliers_NA_SA_3_within_anestry.out &
[3] 12118 - RUNNING 8.10.19. check results log looks ok but .out has some 'failed' terms
plus these files have empty sfs files:
AA - 5 Group1.21:180923-220357, 16 Group1.23:563676-564830
CC - 37 Group6.30:3617-5122
within_ancestry$ nohup parallel --noswap --jobs 2 --header : --colsep '\t' --joblog logs/calc_pi_outliers_NA_SA_3_within_ancestry_repeat_failed.log \
'echo group={pop} region={region}, n={region_n}; ./calc_theta_regions_within_ancestry.sh {pop} \
../bee_samples_listed/byPop/{pop}.list {region} {region_n} {ancestry} results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/{ancestry}/bams' \
::: ancestry AA AA CC :::+ region_n 5 16 37 \
:::+ region Group1.21:180923-220357 Group1.23:563676-564830 Group6.30:3617-5122 \
:::: NA_SA_3.list &> logs/calc_pi_outliers_NA_SA_3_within_ancestry_repeat_failed.out &
[1] 31772 - RUNNING 8.12.19. 

# calculate Fst within ancestry for all outlier regions:
within_ancestry$ nohup parallel --noswap --jobs 3 --joblog logs/calc_fst_outliers_NA_SA_3_within_ancestry.log --header : --colsep '\t' 'echo pop1={pop1} pop2={pop2} region={region}, n={region_n}; ./calc_pairwise_fst.sh {pop1} {pop2} results/outlier_regions/region_{region_n}/{ancestry}' :::: AA_MM_CC.list :::: NA_SA_3.list :::: pairs_fst.list :::: ../functional_analysis/results/outlier_regions/all.plus20kb.bed &> logs/calc_fst_outliers_NA_SA_3_within_ancestry.out &
[1] 22093 - RUNNING 8.13.19. oops needs to find correct directory for A/C/M files. redone:
[1] 454 - RUNNING 8.13.19. KILLED because repeating more often due to NA_SA_3.list unnecessarily in there:
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_fst_outliers_NA_SA_3_within_ancestry.log --header : --colsep '\t' 'echo pop1={pop1} pop2={pop2} region={region}, n={region_n}; ./calc_pairwise_fst.sh {pop1} {pop2} results/outlier_regions/region_{region_n}/{ancestry}' :::: AA_MM_CC.list :::: pairs_fst_NA_SA_only.list  :::: ../functional_analysis/results/outlier_regions/all.plus20kb.bed &> logs/calc_fst_outliers_NA_SA_3_within_ancestry.out &
[3] 27124 # RUNNING 8.13.19 - 924 calls, but each only a few seconds, should take a few hours.


# NOTE: OOPS! The 20kb file didn't actually have any 20kb buffer added (mistake) .. I'll have to remake
# I will keep the files above, knowing they have no buffer, and remake the non-outlier regions:


# now get a set of neutral non-outlier regions to calculate background Fst
# in total, I generate 1Mb in short non-overlapping 100bp regions spread randomly across
# all non-outlier regions of the genom:
within_ancestry$ bedtools random -seed 600 -n 10000 -l 100 -g ../data/honeybee_genome/genome_order_scaffolds_chr_only.lengths | bedtools shuffle -seed 200 -i stdin -excl ../functional_analysis/results/outlier_regions/all.plus20kb.noHeader.bed -noOverlapping -g ../data/honeybee_genome/genome_order_scaffolds_chr_only.lengths | bedtools sort -i stdin -faidx ../data/honeybee_genome/genome_order_scaffolds_chr_only.lengths > results/1Mb_of_non-outlier_100bp.bed
# convert to angsd 1-index instead of bed 0-indexing and ANGSD format chr:start-end :
within_ancestry$ awk '{print $1":"$2+1"-"$3}' results/1Mb_of_non-outlier_100bp.bed > results/1Mb_of_non-outlier_100bp.regions

# calculate background pi
# quick test (starts up ok):
./calc_theta_random_background.sh A ../bee_samples_listed/byPop/A.list 1Mb_of_non-outlier_100bp combined ../filtered_bams/results_Amel4.5
# running all:
within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/calc_pi_random_background.log --header : --colsep '\t' 'echo group={pop}; ./calc_theta_random_background.sh {pop} ../bee_samples_listed/byPop/{pop}.list 1Mb_of_non-outlier_100bp combined ../filtered_bams/results_Amel4.5' :::: groups_theta.list &> logs/calc_pi_random_background.out &
[2] 8957 - RUNNING 8.10.19. No progress in 2 days. Maybe too large
# KILLED. CREATING HUGE FILES. I NEED TO LOOK AT THEM (!). Regions need to be specified chr:start-end (!). If fixed the regions file and am re-running (should be WAY faster!):
[2] 7007 - RUNNING 8.13.19

# and calculate background fst:
within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/calc_fst_1Mb_random_background.log --header : --colsep '\t' 'echo pop1={pop1} pop2={pop2}; ./calc_pairwise_fst.sh {pop1} {pop2} results/non-outlier_regions/1Mb_of_non-outlier_100bp/combined/' :::: pairs_fst.list &> logs/calc_fst_1Mb_random_background.out &
NOT RUN YET
WAITING 4 pi/single SFS to finish!

# Calculate background pi within ancestry for just NA_3 and SA_3:
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_pi_NA_SA_1Mb_random_background.log --header : --colsep '\t' 'echo group={pop} ancestry={ancestry}; ./calc_theta_random_background.sh {pop} ../bee_samples_listed/byPop/{pop}.list 1Mb_of_non-outlier_100bp {ancestry} results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/{ancestry}/bams' :::: AA_MM_CC.list :::: NA_SA_3.list &> logs/calc_pi_NA_SA_1Mb_random_background.out &
[4] 16698 - RUNNING 8.13.19

# Calculate background fst within ancestry for NA_3 and SA_3:
within_ancestry$ nohup parallel --noswap --jobs 2 --joblog calc_fst_within_ancestry_NA_SA_1Mb_random_background.log --header : --colsep '\t' 'echo pop1={pop1} pop2={pop2}; ./calc_pairwise_fst.sh {pop1} {pop2} results/non-outlier_regions/1Mb_of_non-outlier_100bp/combined/' :::: pairs_fst_NA_SA_only.list &> logs/calc_fst_within_ancestry_NA_SA_1Mb_random_background.out &
NOT RUN YET. WAITING 4 pi CALCS TO FINISH FIRST.


# Demographic inference of loss of heterozygosity overall and within ancestry:
# calculate pi within ancestry for background non-outliers:
# here start with AA ancestry and calculate pi for each individual population
# then after you can look at MM and CC ancestries
1Mb_of_non-outlier_100bp
within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/calc_pi_all_pops_within_ancestry_1Mb_random_background.log './calc_theta_random_background.sh {2} ../bee_samples_listed/byPop/{2}.list 1Mb_of_non-outlier_100bp {1} results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/{1}/bams' ::: AA MM CC :::: ../bee_samples_listed/byPop/pops_included.list &> calc_pi_all_pops_within_ancestry_1Mb_random_background.out &
[5] 22628 - RUNNING 8.13.19

# get across all ancestries estimate:
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_pi_all_pops_1Mb_random_background.log './calc_theta_random_background.sh {2} ../bee_samples_listed/byPop/{2}.list 1Mb_of_non-outlier_100bp {1} ../filtered_bams/results_Amel4.5' ::: combined :::: ../bee_samples_listed/byPop/pops_included.list &> calc_pi_all_pops_1Mb_random_background.out &

NOT RUN YET! - WAITING FOR CPU OPEN



# first get slightly stricter ancestry segments:




# for an outlier region: calculate SFS, then pi, then Fst:
