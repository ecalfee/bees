# looking at diversity within A, C, and M ancestry, pi within, and Fst between populations,
# as we move away from the origin of the Africanized honey bee invasion in Brazil

# steps 
# (0) CALL HOMOZYGOUS ANCESTRY TRACTS for AA/CC/MM ancestry above 0.8 posterior probability of having homozygous ancestry across those tracts
output: (e.g.)
local_ancestry/results/tracts/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/AA/CA1207.bed'
# (1) Get bam reads that overlap tracts:
# small test -- works great!
bees/within_ancestry$ parallel './getBamsForTracts.sh {1} {2} {3} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot' ::: CA1207 ::: 3 :::+ CC
# all files:
within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/get_BAMS_AA_CC_MM_ancestry_tracts_0.8.log './getBamsForTracts.sh {1} {2} {3} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot' :::: ../bee_samples_listed/byPop/pops_included.IDs ::: 3 6 8 :::+ CC MM AA &> logs/get_BAMS_AA_CC_MM_ancestry_tracts_0.8.out &
[1] 2874

# (2) calculate pi for each population in ANGSD
# quick test file:
RUNNING (looks like it's working but may take up to a few hours per pop per ancestry)
./pi_within_ancestry.sh AR01 CC thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot ../bee_samples_listed/byPop/AR01.list

# run admixed populations - get pi within ancestry.
bees/within_ancestry$ nohup parallel --noswap --jobs 2 --joblog logs/calc_pi_within_ancestry.log './pi_within_ancestry.sh {2} {1} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot ../bee_samples_listed/byPop/{2}.list' ::: AA CC MM :::: ../bee_samples_listed/byPop/pops_included.list &> logs/calc_pi_within_ancestry.out &
[1] 29414 - RUNNING 8.2.19

# run reference populations, using all reads
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_pi_all.log './pi.sh {1} ../bee_samples_listed/byPop/{1}.list' :::: ../bee_samples_listed/byPop/pops_included_plus_ACM.list &> logs/calc_pi_all.out &
[4] 13830 - RUNNING 8.2.19

# ALTERNATIVELY, I could use the called SNPs for Fst, and get allele freq's for each pop at each of those called SNPs, (filtering w/in ancestry), and quickly calculate Fst etc. from that. This would help me quickly scan for any 'smoking gun' functional differences too. BUT I would miss a new mutation not in this set of alleles, so IF any outliers look like they drop a lot of diversity within ancestry, like a hard sweep, it's also worth looking at those outlier regions using all SNPs from ANGSD and not just previously called SNPs.
# Get all SNPs in a useable 'sites' file for ANGSD:
# filters to only > .05 MAF at start and no non ACGT alleles
data/bees_new_positions$ awk '$3>=.05 && $5!='0' && $6!='0' {print $0}' ALL.bim | cut -f2,5,6 | tr "." "\t" | awk '{print $2"."$3"\t"$4"\t"$5"\t"$6}' > ALL.var.sites
# index this variant sites file for angsd:
data/bees_new_positions$ angsd sites index ALL.var.sites
# calculate allele frequencies at all those SNPs using simple counts:
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_allele_freq_within_ancestry.log './allele_freq_within_ancestry.sh {2} {1} thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot ../bee_samples_listed/byPop/{2}.list ../data/bees_new_positions/ALL.var.sites' ::: AA CC MM :::: ../bee_samples_listed/byPop/pops_included.list &> logs/calc_allele_freq_within_ancestry.out &
[2] 1142 - RUNNING 8.2.19. COMPLETED.
# TO DO: get allele freq's for reference bees too, so I can calculate Fst and have a reference for expected diversity pi (e.g. shouldn't exceed or ancestry calls are off).
# really I want allele freq's for all populations at all the SNPs (across ancestries)
(!) NOTE - I may have swapped major/minor alleles when going from plink to sites file
# because the reference should match the major allele most of the time, not the minor 
# get allele freqs at snps for all bees at all sites (ignoring ancestry)
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/calc_allele_freq_all.log './allele_freq.sh {1} ../bee_samples_listed/byPop/{1}.list ../data/bees_new_positions/ALL.var.sites' :::: ../bee_samples_listed/byPop/pops_included_plus_ACM.list &> logs/calc_allele_freq_all.out &
[3] 9833 - RUNNING 8.2.19. COMPLETED.

# translate allele freqs over to all sites (including NA for no data):
# across all ancestries:
within_ancestry$ nohup parallel --noswap --jobs 1 --joblog logs/combine_allele_freq_all.log 'Rscript ./combine_pop_allele_freqs.R {1} results/allele_freq_all ../data/bees_new_positions/ALL.var.sites' :::: ../bee_samples_listed/byPop/pops_included_plus_ACM.list &> logs/combine_allele_freq_all.out &
[1] 3151 - RUNNING 8.5.19
# for each ancestry separately:
within_ancestry$ nohup parallel --noswap --jobs 3 --joblog logs/combine_allele_freq_within_ancestry.log 'Rscript ./combine_pop_allele_freqs.R {2} results/thin1kb_common3/byPop/output_byPop_CMA_ne670000_scaffolds_Amel4.5_noBoot/{1}/allele_freq  ../data/bees_new_positions/ALL.var.sites' ::: AA CC MM :::: ../bee_samples_listed/byPop/pops_included.list &> logs/combine_allele_freq_within_ancestry.out &
[2] 3855 - RUNNING 8.5.19
# TO DO: paste results together across populations to get 1 file. possibly filter to 1/10 of data for genome-wide estimate.

# alternatively, I could take subsets of the SNPs, or filter by # in pop. with data


# (3) calculate Fst between populations for all pairs in just a subset of 2 CA pops and 3 AR pops, and reference bees A/C/M, also in ANGSD

# (4) get allele frequencies for each population and each ancestry  
