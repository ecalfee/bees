\documentclass[12pt]{report}
\usepackage{amsmath}
\begin{document}

\section{Methods}
These are the methods for the following project: "How selection and hybridization shape the Africanized honey bee invasion."\par

\subsection{Sequencing and alignment}
After sequencing, we align all bees to the Amel v4.5 reference genome (accessed *** from **www.beebase.org**) using Bowtie2 with very-sensitive-local alignment parameters [CITE]. Then using SAMtools, we filter reads with a mapping quality score below 30 [samtools parameters - adjusted mapping score I think is best/used] [CITE] (**and using mpileup we get counts of ref/alt alleles??**).
\subsection{Reference Populations and Calling SNPs}
As reference populations for each of the three major ancestries contributing to genetic diversity in the Americas, we used African (A; n = 11), Eastern European (C; n = 9) and Western/Northern European (M; n = 9) diploid worker bee genomes from the Harpur et al. 2014 dataset, downloaded [Date] from [Source]. This data set consists of diploid worker bee genomes sequenced to an average of 38x [**-**] coverage using Illumina HiSeq (50 bp single-end reads) and was downloaded [Date] from [Source]. We included additional African samples (A; n = 6) from Kenya sequenced to an average of ***x coverage using **** as part of an unpublished study by [NAME], downloaded [Date] from [Source]. For quality control, we also included haploid domesticated drone sequences (n = 6) from Cridland et al. 2018 [Data source ?? - not public??]. \par
These reference bees were mapped using the same procedure as bees from this study, but due to higher coverage we were also able to call genotypes for individual bees. ***Filtering step for heterozygous genotypes or calling genotypes ***. We exclude indels (n = ), SNPs with more than one alternate allele (n = ). For the final variant set, we also excluded sites where two or more of the six haploid drones had heterozygous genotypes using the above procedure. These sites (n = ) indicate regions of the reference genome with low quality assembly, gene duplication, or other sources of incorrect mapping and are correlated with heterozygosity exceeding Hardy-Weinberg expectation in the African reference population (see supplemental Figure ***). Finally, we excluded from further analysis sites out of range for the recombination map (n = ) [CITE Map], including sites on unmapped scaffolds (n = ) with no known placement on the 16 honey bee chromosomes. The final variant set passing quality filtering includes **tot number** SNPs.\par 
The ancestry inference methods we use assume an unlinked variant set and can be confounded by SNPs that are in high LD within an ancestral population. To reduce LD, we first prune SNPs by removing SNPs that provide little ancestry information, due to a less than .2 difference in estimated allele frequency between all pairs of ancestral populations. Second, we remove any additional SNPs in high LD (LD >= 0.8) within the African ancestry reference population using a pruning algorithm in plink that greedily removes variants within a window of 50 SNPs until no pairwise LD comparisons exceed the threshold r-squared (0.8) and then shifts by 10 variants to the next window (plink FILE --indep-pairwise 50 10 0.8). The result is a set of **tot number** unlinked bi-allelic SNPs in the final dataset. A more sophisticated pruning approach might discard sites in LD preferentially by ancestry-informativeness (and high coverage in either ancestral pops or admixed individuals or both) OR repeat multiple times with different random pruning to check robustness of results.\par
Alternatively, I could just use the Cridland SNPs that are in Harpur data and call genotypes for the additional African populations (check if this is the 6 million or 800,000 set .. but I don't want SNPs in LD within the ancestral populations anyways)

\subsection{Global Ancestry Inference}

Global ancestry was assessed with NGSAdmix [CITE], which accounts for the uncertainty in genotype calling from lower coverage sequence data. Because the model underlying NGSAdmix assumes SNPs are unlinked, providing independent information about ancestry, from our variant set we randomly sub-sampled to *** SNPs with LD less than *** in the African reference population. A similar approach was taken in the Harpur study, which assessed global ancestry with ADMIXTURE data and sampled down to 25,000 SNPs at least 5kb apart (excluding singletons) for this analysis and bootstrapped over 100 different samples of 25,000 SNPs per k-value. As input to NGSAdmix, we used BEAGLE genotype likelihoods for all reference bees and bees collected from the hybrid zones for this study ([samtools command]).
\subsection{SNP calling method from Cridland 2017-quoted}
***HOW DID SHE FILTER FOR COVERAGE ACROSS \# OF INDS?***
All of the Illumina-sequenced individuals from Harpur et al. (2014) and the six samples from Kenya were aligned with Bowtie2 using the very-sensitive-local alignment parameters (Langmead and Salzberg 2012).
We used the SAMtools/BCFtools packages (Li et al. 2009) to call genotypes, using a quality score threshold of 30 for the Harpur et al. (2014) data. We imposed some additional quality control filtering of these calls and kept only sites where the coverage for that individual was at least 10x, and we called heterozygous SNPs in individuals where we observed an alternate call at least twice. 
Additionally, we identified all heterozygous sites in the haploid male from Wallberg et al. (2014), for which we required that the minor allele represent at least 5\% of the calls for a given site to consider the site biallelic. Sites that were identified as heterozygous in this sample were excluded from further analysis under the assumption that these sites were heterozygous due to errors in genome assembly. We identified 2,759,184 such sites over the entire 246.927 Mb genome.
Within the Harpur et al. (2014) data set, considering only A. mellifera individuals, we identified 6,281,404 variant sites. Of these sites, 77 had two or more alternate SNP calls.

\subsection{SNP calling methods from Harpur 2014-quoted}
We sequenced the diploid genomes of A. mellifera workers sampled from the four genetically distinct honey bee lineages (19, 20) in Africa (n = 11 workers), Asia (n = 10), East Europe (n = 9), and West/Northern Europe (n = 9) at an average coverage of 38× (Table S1). [...] We discovered 12,041,303 SNPs in the 39 sequenced A. mellifera genomes, many of which were validated using independent datasets
SI Materials and Methods
We developed the following bioinformatic pipeline: (i) FASTQ
files were initially aligned to the Apis mellifera genome assembly
AMELv4.5 using the default parameters of BWA (1) and
alignments were then imported into SAMtools (2) in BAM
format. (ii) We remapped each bee’s sequence using Stampy (3)
at a substitution rate of 0.02 to better align divergent sequences.
(iii) We subsequently realigned sequences with GATK’s Re-
alignerTargetCreator followed by IndelRealigner to reduce any
potential erroneous alignments close to indels (4). We detected
SNPs and created variant calling files (i.e., VCF) using mpileup
(–Q 20 option), bcftools (mutation rate of 0.05), and varfilter (–d 3 –Q 15 –D64) (2). We filtered out highly repetitive regions and
recently duplicated genes from our analyses by first performing
a blastn match of 50-bp segments of the A. mellifera genome back
to the reference genome; we excluded any 50-bp segment matching
two or more locations with fewer than three mismatches and blastn
E-value of 2E-20. An average of 3.2\% of SNPs were masked with
this protocol. We also excluded 6.47 Mb of sequence from un-
mapped scaffolds (scaffolds 17.2000 and above in AMELv4.5)
because of low sequencing coverage in these small (mean 1,957 bp)
and gene-poor scaffolds.

\subsection{SNP calling methods from Wallberg 2014-quoted}
Quality control and variant calling.
	
We performed several steps to improve mapping quality (Supplementary Note). We first identified and marked PCR duplicates using Picard. We next identified regions of poorly and inconsistently mapped reads by realigning around indels. This was done with the Genome Analysis Toolkit (GATK)45. We performed Bayesian population-based SNP calling using FreeBayes across all A. mellifera samples. Biallelic SNPs with a quality score of 50 or greater were retained for further analysis. Several additional filters were then used to reduce the number of false positive SNPs (Supplementary Table 1). These filters were based on an abnormally low number of reads mapping to the SNP, an abnormally high read depth in a 100-bp window around the SNP, low genotype quality (average GQ < 20), a high number of repeat elements close to the SNP and a low number of samples with mapped reads in the region. Sites at which heterozygous calls were obtained in the haploid drone also exhibited an excess proportion of heterozygous calls in worker genotypes. These sites likely represent erroneous calls due to incorrect mapping, for example, in duplicated regions of the genome, and were removed from the analysis. 
	
\subsection{Local Ancestry Inference}
To infer local ancestry across the genome, we used a recently-developed ancestry hidden markov method that can account for genotype uncertainty from low coverage sequence data ([CITE Corbet-Detig ]) and infer the number of generations since admixture [put in admixture hmm code line here]. We include allele counts for A, C, and M reference populations which is used to estimate allele frequencies in the three contributing ancestries. We run each sampled population from the hybrid zone separately. For each individual sequenced from a sampled population, we supply as input to ancestry\_hmm the read counts for reads supporting the reference and alternate alleles at all SNPs in our variant set. Global ancestry proportions from NGSadmix are also used as input into ancestry\_hmm, and their mean is used for the 'migration' proportion, applied population-wide. SNP physical positions are based off of the reference, and genetic distance between SNPs is calculated based on a fine-scale LD-based recombination map [CITE recombination map], using the assumption that all gaps between scaffolds on a particular chromosome have recombination distance equal to the mean recombination rate for that chromosome times the average unassembled gap distance (since true gap distances are unknown, this is the total unassembled physical distance divided by the number of gaps). Because admixture between European lineages in the Americas has been documented in historical museum samples from as early as 1910 ([CITE Cridland 2018]), we model C as a first pulse of admixture into an M population, and then a second later pulse of A admixture, representing the Africanized honey bee invasion. We bounded the number of generations since A admixture between ** and ** as a reasonable time frame for the number of generations since initial introduction of Africanized honey bees (**2*(2018-1957)***). We report but do not interpret the inferred number of generations since admixture because Africanized honey bee admixture was not a single pulse event as assumed by the underlying hidden markov model, but rather a more continuous process as invading Africanized bees encountered additional European populations in their spread North and South across the Americas. Despite this limitation in interpretation, the inferred number of generations is still useful for more accurately fitting the ancestry blocks because the distribution of ancestry block lengths for ongoing admixture can be well approximated by a (more recent) single-pulse event [CITE - maybe rolloff?].

\subsection{Local Ancestry Power Assessment}
We ran simulations to assess our power to call local ancestry accurately across low coverage honey bee genomes. First, we called local ancestry using our pipeline for 8 high-coverage diploid bees from Sky Valley and nearby Idyllwild in Riverside county, California. These bees were published by a study of California bees from Cridland et. al 2018 have **-**x mean sequencing depth, approximately 40\%*** African ancestry, 20\% M and 40\% C European ancestries, and are treated as one admixed population. We randomly sample 1000 scaffolds, in proportion to their length, across the genome. We call ancestry again, on just the set of 100 selected scaffolds and confirm that it matches local inferences using the whole genome [OTHERWISE STOP - NEED TO WORK AT THE CHROMOSOME LEVEL OR LARGER REGIONS, IGNORING START/STOP EDGES]. Then for each of these scaffolds, we down-sample reads to 8x, 6x, 4x, and 2x mean coverage. For the down-sampled datasets, we repeat our ancestry calling procedure and assess the repeatability of local ancestry inference for SNPs with confidently called ancestry (> .9 posterior probability for one of the three ancestries). We find that in the high-coverage dataset, **\% of SNPs have confidently called ancestry (<.1,>.9 or .45-.55), and in figure *** we plot the \% of SNPs with confidently called ancestry using down-sampled reads. Furthermore, of 10,000 confidently called African sites, **\% were called as African/Euro/Etc. in the dataset down-sampled to **x, which is what we subsequently used for sequencing. \par
As an alternative to down-sampling reads, if that is too cumbersome, I can binomially down-sample ref/alt allele coverage for each SNP independently. This would be more efficient and make more sense if reads don't cover more than one SNP.

\end{document}